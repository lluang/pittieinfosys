---
title: 'Lab 7: Tidy data in R'
author: "IE 0015"
date: "February 21/22, 2019"
output:
  html_document: default
  word_document: default
---

Note: this lab should be written using R Markdown.  The lab is provided as an R Markdown file for your convenience as a starting point. You should change the author and date appropriately. For the final submission, you should render (Knit) this as either a Word, PDF, or html document and print that output. (for most people, you will try Word, if that does not work, knit to html then open and print using your browser)

In the `tidyr` package there are two Tuberculosis data sets `who` and `population`.  Look at the `tidyr` help files (R Studio -> Packages tab -> tidyr) to see what each contains. To load and view the last few rows of the datasets, you should enter:

```{r, warning=FALSE, message=FALSE}
library(tidyr)
library(dplyr)
data(who)
tail(who)
```
```{r}
data(population)
tail(population)
```

1. [2] Look the `who` file (which has cases by age), 

a. What represents a single observation?  
b. What makes the `who` dataset NOT comply with the Tidy data rules?  
c. Why do you think this table is organized the way it is?
d. What steps need to be taken make the WHO data tidy? Answer using a flow chart (or process map or pseudocode)

**ANSWER**

A single observation is the number of cases within a specific age range in a single country in a single year.

Each row in the who dataset has several values that refer to different populations (age ranges). Tidy data, each row is a single observation.

The data is organized so that the reader can see all information about a country and year in a single row.

2. [4]  Tidy data

To save effort, only use the variables corresponding to new positive pulmonary smears. (*sp* code is in the name) (the code that does this is presented for you.)

a. Make the data tidy using R and save the results to the data frame `tidywho`. Display the last 6 rows (which should be Zimbabwe)
b. Draw a flow chart that shows the steps to calculate the annual rate of positive pulmonary smears per million population (number divided by population time 1000000) for each country from 2010 through 2012.  
c. Implement (b) in R and display the last 9 rows. (Should be Yemen, Zambia, Zimbabwe)



```{r}
who_new_sp <- who %>% 
  select("country", "iso3", "year", 
         "new_sp_m014",  "new_sp_m1524","new_sp_m2534", "new_sp_m3544", "new_sp_m4554", "new_sp_m5564", "new_sp_m65", 
         "new_sp_f014", "new_sp_f1524", "new_sp_f2534", "new_sp_f3544", "new_sp_f4554", "new_sp_f5564", "new_sp_f65")
```
**ANSWER**
Gather. From each row, take each value, and create a row with the country, year, gender/age range label, and value.

```{r}
tidywho <- who_new_sp %>% gather(`new_sp_m014`,  `new_sp_m1524`, `new_sp_m2534`, `new_sp_m3544`, `new_sp_m4554`, `new_sp_m5564`, `new_sp_m65`,   `new_sp_f014`, `new_sp_f1524`, `new_sp_f2534`, `new_sp_f3544`, `new_sp_f4554`, `new_sp_f5564`, `new_sp_f65`, key = "genderage", value="cases") %>%
  arrange(country, year)
tidywho %>% tail()  
```
```{r}
(ratesp <- tidywho %>% filter(year %in% c(2010, 2011, 2012)) %>%
  group_by(country, iso3, year) %>%
  summarize(spcases = sum(cases, na.rm = TRUE)) %>% 
  left_join(population, by=c("country", "year")) %>%
  mutate(sprate = spcases/population*1000000)) %>%
  tail(9)
```

3. [4] Create a table with one line per country with three years.

a.  Using the results of 2, (a dataframe with country, iso3, year, cases of sp, population, and rate per million) draw a flow chart that will create a data frame with the country, iso3, and columns with the rate per million cases of positive pulmonary smears for each of 2010, 2011, 2012. (so 5 columns total).

b.  Implement this in R code.  Display the last 6 rows when sorted by name of the country.

```{r}
ratesp %>% select(country, iso3, year, sprate) %>%
  spread(year, sprate) %>%
  arrange(country) %>% tail()
```
