---
title: 'Homework 2:  Exploratory Data Analysis'
author: "IE 0015"
date: "March ??, 2018"
output:
  pdf_document: default
  html_document: default
---

For the homework assignments, code and narrative should be written using R Markdown.  Process maps can be written on separate pieces of paper. You should render the R Markdown as PDF or Word, print the output, and staple with the process maps for the complete submission.

In the `tidyr` package there are two Tubeculosis data sets `who` and `population` (you used them in Lab 3).  Look at the `tidyr` help files (R Studio -> Packages tab -> tidyr) to see what each contains. To load and view the last few rows of the datasets, you should enter:

```{r, warning=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(magrittr)
library(countrycode) # you probably need to install this 
data(who)
data(population)
```


This lab will use the tuberculosis dataset and focus on the 10 countries that are part of the Association of South East Asian Nations (ASEAN):   Brunei, Cambodia, Indonesia, Laos, Malaysia, Myanmar (Burma), the Philippines, Singapore, Thailand, and Vietnam. The provided code will pick up from Homework 1, by combining the TB and population data, then breaking out the diagnosis, gender, and age range.




The following code is provided as a starting point from homework 1.


```{r}
who_new <- who[,c("country", "iso2", "iso3", "year", "new_sp_m014",  "new_sp_m1524","new_sp_m2534", "new_sp_m3544", "new_sp_m4554", "new_sp_m5564", "new_sp_m65", "new_sp_f014", "new_sp_f1524", "new_sp_f2534", "new_sp_f3544", "new_sp_f4554", "new_sp_f5564", "new_sp_f65",  
"new_sn_m014",  "new_sn_m1524", "new_sn_m2534", "new_sn_m3544", "new_sn_m4554", "new_sn_m5564","new_sn_m65",   "new_sn_f014",  "new_sn_f1524", "new_sn_f2534", "new_sn_f3544", "new_sn_f4554","new_sn_f5564", "new_sn_f65",   
"new_ep_m014",  "new_ep_m1524", "new_ep_m2534", "new_ep_m3544","new_ep_m4554", "new_ep_m5564", "new_ep_m65",   "new_ep_f014",  "new_ep_f1524", "new_ep_f2534","new_ep_f3544", "new_ep_f4554", "new_ep_f5564", "new_ep_f65",   
"newrel_m014",  "newrel_m1524","newrel_m2534", "newrel_m3544", "newrel_m4554", "newrel_m5564", "newrel_m65",   "newrel_f014","newrel_f1524", "newrel_f2534", "newrel_f3544", "newrel_f4554", "newrel_f5564", "newrel_f65")]

tidywho <- who_new %>% gather(`new_sp_m014`,  `new_sp_m1524`, `new_sp_m2534`, `new_sp_m3544`, `new_sp_m4554`, `new_sp_m5564`, `new_sp_m65`,   `new_sp_f014`, `new_sp_f1524`, `new_sp_f2534`, `new_sp_f3544`, `new_sp_f4554`, `new_sp_f5564`, `new_sp_f65`, 
`new_sn_m014`,  `new_sn_m1524`, `new_sn_m2534`, `new_sn_m3544`, `new_sn_m4554`, `new_sn_m5564`,`new_sn_m65`,   `new_sn_f014`,  `new_sn_f1524`, `new_sn_f2534`, `new_sn_f3544`, `new_sn_f4554`,`new_sn_f5564`, `new_sn_f65`,   
`new_ep_m014`,  `new_ep_m1524`, `new_ep_m2534`, `new_ep_m3544`,`new_ep_m4554`, `new_ep_m5564`, `new_ep_m65`,   `new_ep_f014`,  `new_ep_f1524`, `new_ep_f2534`,`new_ep_f3544`, `new_ep_f4554`, `new_ep_f5564`, `new_ep_f65`,   
`newrel_m014`,  `newrel_m1524`,`newrel_m2534`, `newrel_m3544`, `newrel_m4554`, `newrel_m5564`, `newrel_m65`,   `newrel_f014`,`newrel_f1524`, `newrel_f2534`, `newrel_f3544`, `newrel_f4554`, `newrel_f5564`, `newrel_f65`,
key = "subgroup", value="cases")
tidywho$year <- as.integer(tidywho$year)
```

1.  [2] Create a subset of tidywho that only includes the ASEAN nations.  Name this `whoasean`. Note that the list of nations and the corresponding ISO codes is provided below. You will need the package `countrycode` to make this work.

Note:

  i.  This is the first problem because filtering the data will make your R data processing code much faster.

```{r}
#The ASEAN Nations are: 
aseancountries <- c("Brunei", "Cambodia", "Indonesia", "Lao", "Malaysia", "Myanmar", "Philippines", "Singapore", "Thailand", "Vietnam")
aseaniso2 <- countrycode(aseancountries, "country.name", "iso2c")
```

**ANSWER**

```{r}
whoasean <- tidywho %>% 
              filter(iso2 %in% aseaniso2)
```

The following code will take `whoasean` and generate columns for the diagnosismode, agerange, and gender (i.e. what you did in homework 1)

```{r}
whoasean$subgroup1 <- substring(whoasean$subgroup, 4, length(whoasean$subgroup))
diagnosismode <- c()
gender <- c()
agerange <- c()
for(newrange in whoasean$subgroup1){
  subgroupsplit <- strsplit(newrange, split= "_")
  diagnosismode <- append(diagnosismode,  subgroupsplit[[1]][length(subgroupsplit[[1]])-1])
  subgrouplast <- subgroupsplit[[1]][length(subgroupsplit[[1]])]
  gender <- append(gender, substring(subgrouplast, 1, 1))
  agerange <- append(agerange, substring(subgrouplast, 2, nchar(subgrouplast)))
}
whoasean$diagnosismode <- diagnosismode
whoasean$gender <- gender
whoasean$agerange <- agerange
```

2.  [10] Group and plot the total rate of diagnosis of TB per year for each country in a form that is comparable. 

  a. Draw a process map that illustrates how to do this.
  b. Generate the visualization. Note that it should include a time series for each country in a form that will be visual using black and white printing.

Note: 

  i. You need to determine what type of plot to use to visualize all 10 countries. 
  ii. You should also make sure that the country data visualizations are comparable, meaning that you should be using rates and the axis should align.
  iii. The code below is based on the solution from Homework 1 and you can use this as a starting point.  You can also use this code to get your process map started (each line corresponds to a box in your process map.)
  iv. Throughout this assignment, you may use ISO2 codes instead of the country names.
  
```{r}
aseanrates <- whoasean %>% 
  filter(year>2000, year<2012) %>%
    group_by(country, iso2, year) %>%
      summarize(newcases=sum(cases, na.rm=TRUE)) %>%
        left_join(population) %>%
          mutate(rate=newcases/population*100000)
```

**ANSWER**

```{r}
ggplot(aseanrates, aes(year, rate)) + geom_line() +
  facet_grid(iso2~ .)
```

```{r}
ggplot(aseanrates, aes(year, rate, color=iso2)) + geom_line() +
  scale_color_brewer(palette = "Paired") + theme_bw()
```


3.  [13] You are interested in how the different countries have been changing the ratio of use of the various diagnosis modes have been changing per year.

  a.  Draw a process map to create the dataset with country and diagnosis mode by year.
  b.  Design and immplement three visualizations. Note: the country can be referenced using ISO2 codes. The diagnosis should be indicated using the full words (not a code). The three visualizations should use different *geom* and should use a printer friendly color map. The data dictionary is at http://www.who.int/tb/country/data/download/en/

  
**ANSWER**
  
```{r}
aseanmodes <- whoasean %>% 
  filter(year>2000, year<2012) %>%
    group_by(country, iso2, diagnosismode, year) %>%
      summarize(newcases=sum(cases, na.rm=TRUE)) %>%
        left_join(population) %>%
          mutate(rate=newcases/population*100000)
```

```{r}
ggplot(aseanmodes, aes(year, rate, color=diagnosismode)) +
  geom_point() + geom_line() +
  scale_x_discrete(breaks = c(2002, 2004, 2006, 2008, 2010, 2012)) +
  scale_color_brewer(palette="Set2") +
  scale_y_continuous(name = "rate per 100,000") +
  facet_grid(. ~ iso2) +
  theme(axis.text.x = element_text(angle=90))
```
