---
title: 'Homework 1: Data manipulation with dplyr'
author: "IE 0015"
date: "January 30, 2020"
output:
  html_document: default
  pdf_document: default
---

For the homework assignments, code and narrative should be written using R Markdown. Where process maps are needed you may write them in as pseudocode, draw them and add them to a Word Document You should render (knit) the R Markdown as a Word document, print the output, and staple with the process maps for the complete submission.

The first part of this homework assignment you will repeat labs 1 and 2, but you will do them in R using the dplyr/magrittr packages. Then you will generate the five basic plots.

```{r, warning=FALSE}
library(tidyr)
library(dplyr)
library(magrittr)
library(ggplot2)
library(readxl)
library(readr)
```

The CrossFit Open is an international fitness competition where athletes compete in a series of weekly events. Events are scored by a judge in a CrossFit affiliate (gym) and the scores are used to qualify athletes for the annual CrossFit Games or for other competitions that will take place over the year.  In 2019 the CrossFit Open occurred in February/March. For 2020, the Crossfit Open corresponding to the 2020 Crossfit Games occurred in October/November.

As each event is unique and not directly convertable, cumulative scoring is based on the sum of the individual's rank in each event worldwide, so lower scores are better.

1. Load the affiliate and the two CrossFit Open files based on the following rule:

-  Use the first letter of your last name. 
-  If you are in a team of two, use the last name of the person whose first name comes first alphabetically.

Last (family) name:  A-L: Men,  M-Z: Women


**ANSWER**
```{r}
datadirectory <- "C:\\Users\\louis\\Documents\\courses\\crossfitopen"
Affiliate_list <- read_csv(file.path(datadirectory, "Affiliate_list.csv"),
                           col_types = cols(Affiliate_id = col_character()))
athlete2019list <- read_csv(file.path(datadirectory, "2019_opens_athletes.csv"), 
                            col_types = cols(affiliateid = col_character(), competitorid = col_character()))
scores2019 <- read_csv(file.path(datadirectory,"2019_opens_scores.csv"),
                       col_types = cols(competitorid = col_character()))
athlete2020list <- read_csv(file.path(datadirectory, "2020_opens_athletes.csv"), 
                            col_types = cols(affiliateid = col_character(), competitorid = col_character()))
scores2020 <- read_csv(file.path(datadirectory,"2020_opens_scores.csv"),
                       col_types = cols(competitorid = col_character()))
```

1. [15] Affiliates would like to compare where they are to other nearby affiliates.  You should group by either states or countries (depending on if there are enough affiliates in a state for grouping by state to make sense.)  Do the following using `dplyr`, 
Identify all athletes who participated in the CrossFit Open in the main (not age group or scaled divisions) in both 2019 and 2020.  List the top 10 affiliates based on the athletes who competed from that affiliate in 2020 for the state/country that represents your place of birth. 

a. [5] Make a list of athletes who competed in both 2019 and 2020 in the Men or Women division (as appropriate.
b. [5] Group athletes and count by affiliate based on 2020 affiliation.
c. [5] Identify top 10 affiliates and calculate the number of repeat athletes who were there in 2020, and the average and spread of the improvement.


Notes: 
    -  You should use the 2020 data to identify athletes by affiliate and the competition division. Because later you are treating the affiliate as a customer, and they are only interested in current members.
    -  You should make the list of repeat athletes first, then group by and summarize by affiliate, then filter by country/state
    

**ANSWER**
a
```{r repeatathletes}
repeatathletes <- athlete2020list %>% filter(division=="Women") %>%
  inner_join(athlete2019list, by=c("competitorid"="competitorid", "division"="division")) 
```


```{r affiliaterepeats}
athletesaffiliates <- Affiliate_list %>%
  left_join(repeatathletes, by=c("Affiliate_id"="affiliateid.x")) %>%
  select(Affiliate_id, Affiliate_name, State, Country, overallrank.x, overallrank.y) %>%
  mutate(improvement = overallrank.y - overallrank.x)
```

c
```{r countaffiliateathletes}
athletesaffiliates %>% 
  group_by(Affiliate_name, State, Country) %>%
  summarize(athletes2020 = n()) %>%
  filter(State=="MO") %>%
  arrange(-athletes2020) %>%
  head(10)
```


2. [10] For the top 10 affiliates in the state/country, calculate and show the number of athletes, average improvement in rank, and standard deviation of improvement who participated in  both the 2019 and 2020 Open.  

**ANSWER**
```{r}
athletesaffiliates %>% 
  group_by(Affiliate_name, Country, State) %>%
  summarize(athletes2020 = n(),
            avgimprovement = mean(improvement, na.rm=TRUE),
            rangeimprovement = max(improvement, na.rm=TRUE)-min(improvement, na.rm=TRUE)) %>%
  filter(State=="MO") %>%
  arrange(athletes2020) %>%
  head(10)
```

3.  [15] For your state/country, take the top 10 affiliates and create a boxplot of the improvement in the athletes for those affiliates.  

Note: that your plot needs labels for the x and y axis and a title that identifies the information presented and the region the plot is for.

Note: search on the internet for "ggplot rotate axis labels" to see how to rotate the x-axis labels.

**ANSWER**
```{r}
top10 <- athletesaffiliates %>% 
  group_by(Affiliate_name, Affiliate_id, Country, State) %>%
  summarize(athletes2020 = n(),
            avgimprovement = mean(improvement, na.rm=TRUE),
            rangeimprovement = max(improvement, na.rm=TRUE)-min(improvement, na.rm=TRUE)) %>%
  filter(State=="MO") %>%
  arrange(athletes2020) %>%
  head(10)
```
```{r}
athletestop10 <- top10 %>%
  left_join(athletesaffiliates, by="Affiliate_id")
```

```{r}
ggplot(athletestop10) + geom_boxplot(aes(x=Affiliate_name.x, y=improvement)) +
  ylab("Improvement in rank") + xlab("Affiliate name") + ggtitle("Improvement in affiliates in North Central Region from 2017 to 2018 CrossFit Open") + theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

4. [10]  For one of the top 5 affiliates in the region, create a plot that shows the improvement of each athletes who participated in both the 2017 and 2018 Open.  Assume that your client is the head coach of that affiliate.  Explain to the coach how to interpret the plot and the implication.  Note that the plot needs meaningful axis titles and a main title. 

**ANSWER**
```{r}
Windycity <- athletestop10 %>% 
  filter(Affiliate_name.x=="Windy City CrossFit")
```

```{r}
ggplot(Windycity) + geom_histogram(aes(improvement)) +
  xlab("Improvement in rank from 2017 to 2018") + 
  ylab("Number of athletes") +
  ggtitle("Improvement in athletes from Windy City CrossFit from 2017 to 2018 CrossFit Open")
```

Discuss if athletes generally improved, generally got worse, or were generally the same.  Discuss spread (range or variance)