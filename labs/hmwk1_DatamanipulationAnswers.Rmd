---
title: 'Homework 1: Data manipulation'
author: "IE 0015"
date: "February 15, 2017"
output:
  html_document: default
  pdf_document: default
---

For the homework assignments, code and narrative should be written using R Markdown.  Process maps can be written on separate pieces of paper. You should render the R Markdown as PDF or Word, print the output, and staple with the process maps for the complete submission.

In the `tidyr` package there are two Tubeculosis data sets `who` and `population` (you used them in Lab 3).  Look at the `tidyr` help files (R Studio -> Packages tab -> tidyr) to see what each contains. To load and view the last few rows of the datasets, you should enter:

```{r, warning=FALSE}
library(tidyverse)
data(who)
tail(who)
```
```{r}
data(population)
tail(population)
```

1. [4] Look the `who` and `population` data sets from the `tidyr` package (the information files are in the `tidyr` package help files).  Make the `who` dataset tidy data (Note: see lab 3) with the following columns:  Country, iso2, year, subgroup, cases.  For `subgroup`, the value should be what are currently column headings. (in lab 3 you used `agerange`) Similarly to lab 3, the following code is provided as a starting point.


```{r}
who_new <- who[who$year>2010,c("country", "iso2", "iso3", "year", "new_sp_m014",  "new_sp_m1524","new_sp_m2534", "new_sp_m3544", "new_sp_m4554", "new_sp_m5564", "new_sp_m65", "new_sp_f014", "new_sp_f1524", "new_sp_f2534", "new_sp_f3544", "new_sp_f4554", "new_sp_f5564", "new_sp_f65",  
"new_sn_m014",  "new_sn_m1524", "new_sn_m2534", "new_sn_m3544", "new_sn_m4554", "new_sn_m5564","new_sn_m65",   "new_sn_f014",  "new_sn_f1524", "new_sn_f2534", "new_sn_f3544", "new_sn_f4554","new_sn_f5564", "new_sn_f65",   
"new_ep_m014",  "new_ep_m1524", "new_ep_m2534", "new_ep_m3544","new_ep_m4554", "new_ep_m5564", "new_ep_m65",   "new_ep_f014",  "new_ep_f1524", "new_ep_f2534","new_ep_f3544", "new_ep_f4554", "new_ep_f5564", "new_ep_f65",   
"newrel_m014",  "newrel_m1524","newrel_m2534", "newrel_m3544", "newrel_m4554", "newrel_m5564", "newrel_m65",   "newrel_f014","newrel_f1524", "newrel_f2534", "newrel_f3544", "newrel_f4554", "newrel_f5564", "newrel_f65")]
```

**ANSWER**

```{r}
tidywho <- who_new %>% gather(`new_sp_m014`,  `new_sp_m1524`, `new_sp_m2534`, `new_sp_m3544`, `new_sp_m4554`, `new_sp_m5564`, `new_sp_m65`,   `new_sp_f014`, `new_sp_f1524`, `new_sp_f2534`, `new_sp_f3544`, `new_sp_f4554`, `new_sp_f5564`, `new_sp_f65`, 
`new_sn_m014`,  `new_sn_m1524`, `new_sn_m2534`, `new_sn_m3544`, `new_sn_m4554`, `new_sn_m5564`,`new_sn_m65`,   `new_sn_f014`,  `new_sn_f1524`, `new_sn_f2534`, `new_sn_f3544`, `new_sn_f4554`,`new_sn_f5564`, `new_sn_f65`,   
`new_ep_m014`,  `new_ep_m1524`, `new_ep_m2534`, `new_ep_m3544`,`new_ep_m4554`, `new_ep_m5564`, `new_ep_m65`,   `new_ep_f014`,  `new_ep_f1524`, `new_ep_f2534`,`new_ep_f3544`, `new_ep_f4554`, `new_ep_f5564`, `new_ep_f65`,   
`newrel_m014`,  `newrel_m1524`,`newrel_m2534`, `newrel_m3544`, `newrel_m4554`, `newrel_m5564`, `newrel_m65`,   `newrel_f014`,`newrel_f1524`, `newrel_f2534`, `newrel_f3544`, `newrel_f4554`, `newrel_f5564`, `newrel_f65`,
key = "subgroup", value="cases")
tidywho %>% tail(20)
```

2.  [10] In the subgroup column, there are actually three pieces information: the mode of diagnosis,  gender, and the age range.
  a. Draw a process map for the steps to take to extract age range, diagnosis mode, and gender by year from the original column names. Note: in a process map, each function in (b) should correspond to a block on the process map.
  b. In R, create three new columns 'agerange', 'gender', 'diagnosismode' and populate them based on the current value of subgroup. (note: 'agerange' is going to be the hardest of the three, I suggest starting with 'gender'). Print out the last 20 rows of Country, iso3, year, agerange, gender, diagnosismode, cases.  Note: because of the size of the dataset, start by making a dataframe with the last 15 rows of tidywho where the year is after 2008 (i.e. 2009-2014).

Notes: 
  1. To split a string by character position, use `substring`
  2. The total number of characters in a string can be found by `length(stringname)`
  3. `strsplit` takes a string and splits it using a character to split the string. e.g.
  `splittedstring <- strplit(stringname, split="_")
  4. `strsplit` returns a list of length 1, and it accessed by `splittedstring[[1]]`

```{r}
tidywho2011 <- tidywho %>% filter(year>2010)
```
  
  
**ANSWER**

1. From subgroup, remove the first three characters `new`
2. Split subgroup by `_`
3. Note  that there are 2 groups formed by the split (if you removed `new` first)
4. The first character of the last subgroup is the gender
5. The first subgroup is the diagnosis mode
6. The age range comes after the 1st character of the last subgroup
  6a. If there are 3 digits, the first digit is the beginning and the last two digits are the end of the range
  6b. If there are 4 digits, the first two digits is the beginning and the last two digets are the end of the range
  6c. If there are 2 digits, the digits represent the beginning of the age range.


```{r}
tidywho2011$subgroup1 <- substring(tidywho2011$subgroup, 4, length(tidywho2011$subgroup))
diagnosismode <- c()
gender <- c()
agerange <- c()
for(newrange in tidywho2011$subgroup1){
  subgroupsplit <- strsplit(newrange, split= "_")
  diagnosismode <- append(diagnosismode,  subgroupsplit[[1]][length(subgroupsplit[[1]])-1])
  subgrouplast <- subgroupsplit[[1]][length(subgroupsplit[[1]])]
  gender <- append(gender, substring(subgrouplast, 1, 1))
  agerange <- append(agerange, substring(subgrouplast, 2, nchar(subgrouplast)))
}
tidywho2011$diagnosismode <- diagnosismode
tidywho2011$gender <- gender
tidywho2011$agerange <- agerange
tidywho2011 %>% tail(15)
```

3.  [6] You need a table of rates of annual diagnosis by country for the last 3 years (2011-2013).
  a. Draw a process map that creates a table with the total rate (per 100,000) of new diagnosis for each country for each year by diagnosis mode. Note: it this table should be tidy.
  b. Implement the procedure, then you should have a table with: Country, iso3, diagnosismode, rate.  Note that this requires combining the data elements for gender and age ranges.
  c. Display the last 15 rows (5 countries).
  
**ANSWER**

Make a table of total diagnosis by country, then combine it with the population table, then get rates.
```{r}
tidywho2011 %>% 
    group_by(country, year) %>%
      summarize(newcases=sum(cases, na.rm=TRUE)) %>%
        left_join(population) %>%
          mutate(rate=newcases/population*100000) %>% tail(15)
```
