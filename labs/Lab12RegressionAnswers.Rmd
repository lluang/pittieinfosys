---
title: 'Lab 12: Regression'
author: "IE 0015 Information Systems Engineering"
date: "April 2016"
output: pdf_document
---

```{r loadlibraries,  warning=FALSE}
options(digits = 3, scipen=4)
library(ggplot2, quietly = TRUE)
library(dplyr)
library(modelr)
#library(VIM, quietly=TRUE, warn.conflicts = FALSE)

titanic <- read.csv("../data/titanic3.csv",
                    header=TRUE, sep=",")
# From Lab on working with characters and regular expressions
getTitle <- function(data) {
  title.dot.start <- regexpr("\\,[A-Z ]*\\.", data$name, TRUE)
  title.comma.end <- title.dot.start+ attr(title.dot.start, "match.length")
  data$Title <- substr(data$name, title.dot.start+2, title.comma.end-1)
  return (data$Title)
}  
titanic$Title <- getTitle(titanic)
unique(titanic$Title)  
```

# 1.  kNN imputation (3pts).

Identify the records that are missing age data.  Include the information from the title as part of information on each passenger.
  a. Use kNN imputation to fill in these values based on 7 nearest neighbors.
  b. Display a few of the records that previously were  missing ages.  How does the records that were imputed using kNN compare to the methods you used in last week's lab? Explain your answer.

ANSWER
------
```{r}
I = which(is.na(titanic$Age))
head(titanic[I,])
titanic2 <- kNN(titanic, k = 7)
head(titanic2[I,])
```
The values should feel closer because there is more variety in the imputed records due to the averaging of records that were similar.
Also, they feel more correct than hot deck imputation because the assignment of an age to a person is based on characteristics.

# 1. Multiple linear regression (4 pts)

You think that the age is dependent on the following

  i.  Sex
  ii.  Pclass

  a.  Remove lines in the data that do not have an age
  a.  Develop a multiple linear regression model for the age based on these characteristics.
  b.  Display the summary and the analysis of variance tables for this model. 
  c.  Display diagnostics plots. Discuss the three assumptions of regression models.
  d.  Do you think this is an adequate model?
  
ANSWER
======

a-b. Model
```{r}
titanic <- titanic[!is.na(titanic$age),]
age.lm <- lm(age ~ sex + pclass, data=titanic)
summary(age.lm)
anova(age.lm)
```
c. Diagnostic plots
```{r}
par(mfrow=c(2,2))
plot(age.lm)
par(mfrow=c(1,1))
```

-  Normality (looks pretty good, only breaks off the 45 degree line near the top of the distribution)
-  Error distribution seems independent (very young and old are different, but that may be because so few points)
-  Constant variance (only changes as for passengers that are   very young or very old)
-  Bonus: Cook's distance does not fit inside the boundaries.
-  You should comment that there are only 6 predicted values.

# 2 Adding to the model.
There are two variables that are generally present but are not currently in the model: fare and Title. 

a. Plot the residuals of your model against each of these and choose which value should be added to the model.
b. Create the linear regression model that adds the new variable and print the summary, anova table, and diagnostic plots.
c. Compare the new model to the original.



Compare the residuals against the Title.

```{r}
titanic$lmresiduals <- age.lm$residuals
ggplot(titanic) + geom_boxplot(aes(Title, lmresiduals))
```

```{r}
ggplot(titanic) + geom_point(aes(fare, lmresiduals))
```

The residuals for each fare seem to have the same range for most values of the fare.  But their are large differences in the boxplots when plotting against the title, so add the title.

```{r}
age.lm2 <- lm(age ~ sex + pclass + Title, titanic)
summary(age.lm2)
anova(age.lm2)
```

```{r}
par(mfrow=c(2,2))
plot(age.lm2)
par(mfrow=c(1,1))
```

There are more varied predicted values of age. Many of the residuals are very small because of few samples. For those with many samples, the residuals are smaller, and about even.

Note that Cook's distance is now within the lines.
QQ plot looks better at the top.

Sum of squares residuals much smaller.