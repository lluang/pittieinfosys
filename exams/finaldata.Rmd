---
title: "Fire and violations data for final"
author: "IE 0015 Information Systems"
date: "April 16, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(magrittr)
library(tidyr)
library(stringr)
library(lubridate)
library(ggplot2)
library(readr)
```

```{r multiplot, echo=FALSE, warning=FALSE, message=FALSE}
# Multiple plot function
#
# ggplot objects can be passed in ..., or to plotlist (as a list of ggplot objects)
# - cols:   Number of columns in layout
# - layout: A matrix specifying the layout. If present, 'cols' is ignored.
#
# If the layout is something like matrix(c(1,2,3,3), nrow=2, byrow=TRUE),
# then plot 1 will go in the upper left, 2 will go in the upper right, and
# 3 will go all the way across the bottom.
#
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}
```


```{r readdata}
datadirectory <- "E:/Box Sync/courses/InfoSystems/infosysSP2018/"
#datadirectory <- "C:/Users/louis/Desktop/Box Sync/courses/InfoSystems/infosysSP2018/"
pittsburgh_fire_incidents <- read_csv(file.path(datadirectory, "pittsburgh_fire_incidents.csv"),
    col_types = cols(alarm_time = col_datetime(format = "%Y-%m-%dT%H:%M:%S"),
    arrival_time = col_datetime(format = "%Y-%m-%dT%H:%M:%S"), 
    census_tract = col_character(),
    council_district = col_character(),
    incident_type = col_character(),
    pli_division = col_character(), police_zone = col_character(),
    public_works_division = col_character(),
    tract = col_character(), ward = col_character())
)

pittsburgh_PLI_violations <- read_csv(file.path(datadirectory, "pittsburgh_PLI_violations.csv"),
    col_types = cols(COUNCIL_DISTRICT = col_character(),
    PLI_DIVISION = col_character(), POLICE_ZONE = col_character(),
    PUBLIC_WORKS_DIVISION = col_character(),
    STREET_NUM = col_character(), TRACT = col_character(),
    WARD = col_character(), `_id` = col_character())
)
```

#  Pittsburgh 9th district

Rev. Ricky Burgess is the City Councilman for Pittsburgh's 9th district, which includes the neighborhoods of East Liberty, Homewood, East Hills, Friendship, Garfield, Point Breeze, and Larimer on Pittsburgh's East side.  He believes that one obstical to development in Pittsburgh's east side are property owners who neglect maintaining their property and that this neglect is also seen in fires. Investigating these properties may lead to getting these properties being put on the market for purchase by owners who are more interested in putting these properties to productive use through either encouraging neglectful land ownders to put the property on the market or outright seizure for violations of a range of ordinances.

# Company real estate

A company is looking at buying a very large quantity of commercial and industrial space. They are looking for large amounts of space available in relatively close proximity. As they are big enough to justify new construction, they look at permit, licensing, and inspection violations as well as previous history of fire as opportunities to purchase property at a low price.  So they are looking for both good quality locations (no violations) and locations that are potentially inexpensive for new construction.

#  Commercial property insurance

Insurance companies sell policies to commercial property owners so that in the case of major damage such as a fire the property owners will have resources to repair their property. 
The insurance company wants to set rates so that in the long run, they receive more in insurance premiums (rates) than they pay out in claims. 
However, if they set premiums too high, competitors can charge less and still make a long term profit.
An insurance company believes that a history of permits, licensing, and inspection violations as well as major and minor fire incidents should be used to adjust premiums.  

#  Data wrangling


a. What follows are the top ten types of fires in the Pittsburgh fire incidents databases.  Draw the process map that generates this list. (Note: "Type" is "type_description" in the Pittsburgh fire database)


```{r, echo=FALSE, warnings=FALSE, message=FALSE}
names(pittsburgh_fire_incidents)[which(names(pittsburgh_fire_incidents) == "type_description")] <- "Type"
pittsburgh_fire_incidents %>%
  group_by(Type) %>%
  summarize(number=n()) %>%
  arrange(desc(number)) %>%
  head(10)
```

b.  Because Councilman Burgess is only interested in property neglect fires, he is not interested in cooking or interior fires.  Draw the processmap that identifies all fires that involve a building, structure,or trash in Council District 9. Note: look for the words "building", "structure", or "trash" in the Type description. Check the list above to make sure you cover all cases.

c.  Notice that the addresses in the fire and incidents databases are recorded differently (see example in attachement. Note that they should indicate a match when you are done).  Draw a process map that will convert the addresses so that they do match each other.  Note that addresses ending in "00" indicate that it is not an exact address, but identifies the block on the street.  (i.e. when you are done, the field(s) with the address will match using `join` commands that identify equalities)



i. Search for any of the words (includine possibility of initial capital) within the type description.
ii. Include if one of the words is available, or if the council_district == 9


```{r}
keywordsregex <- "[B|b]uilding|[S|s]tructure|[T|t]rash"
streetnumberregex <- "^\\d|"
pittsburgh_building <- pittsburgh_fire_incidents %>%
  filter(str_detect(Type, keywordsregex),
         !str_detect(address, "\\&")) %>%
  mutate(STREET_NUM= str_extract(address, "[:digit:]+(?=[:space:])"),
         STREET_NAME = str_extract(address, "(?<=BLOCK[:space:])[[:alpha:]+[:space:]]*(?=,)"),
         block_num=floor(as.numeric(STREET_NUM)/100)*100)
```

From the fire incidents data
i. Pull out the number at the beginning of `address` if available and call this STREET_NUM.
ii.  Skip the word 'BLOCK'
iii. Pull remainder of street name after BLOCK up to the comma and call this STREET_NAME
iv.


#  You 

```{r}
pittsburgh_PLI_violations %>%
  group_by(STREET_NUM, STREET_NAME) %>%
  summary(number = n()) %>%
  head(10)
```
```{r}
pittsburgh_PLI_violations %>%
  mutate(block_num=floor(as.numeric(STREET_NUM)/100)*100) %>%
  distinct(block_num, STREET_NAME) %>%
  summarize(count=n())
```
```{r}
unique(pittsburgh_building$STREET_NUM)
```

# Duke GPA

1. A survey of 55 Duke University students asked about their GPA, number of hours
they study at night, number of nights they go out, and their gender.
```{r}
library(openintro)
data(gpa)
gpa_lm1 <- lm(gpa ~ studyweek, data=gpa)
anova(gpa_lm1)
```


```{r}
par(mfrow=c(2,2))
plot(gpa_lm1)
par(mfrow=c(1,1))
title("Diagnostic plots")

```

a.  Comment on the quality of the model given the four diagnostic plots and the ANOVA table.
b.  The three other variables collected were number of hours the students slept per night, number of nights they go out, and gender. (note that `studyweek` is already in the model)  Below are the sorted residual plots. Which variable(s) should be added to the model and why?

```{r}
gpa$residulas <- gpa_lm1$residuals
```

```{r}
gpaplot <- ggplot(gpa, aes(y=residulas))
p1 <- gpaplot + geom_point(aes(x=studyweek))
p2 <- gpaplot + geom_point(aes(x=sleepnight))
p3 <- gpaplot + geom_point(aes(x=out))
p4 <- gpaplot + geom_point(aes(x=gender))
multiplot(p1, p2, p3, p4, cols=2)
```


# Baby weights


1. The Child Health and Development Studies investigate a range of
topics. One study considered all pregnancies between 1960 and 1967 among women in the Kaiser
Foundation Health Plan in the San Francisco East Bay area. Here, we study the relationship
between smoking and parity and weight of the baby. The variable `smoke` is coded 1 if the mother is a smoker, and 0 if not. The variable `parity` is coded 0 if first born, 1 otherwise.  
```{r}
library(openintro)
data(babies)
babies <- babies[complete.cases(babies),]
babies_lm1 <- lm(bwt ~ smoke + parity, data=babies)
anova(babies_lm1)
```


```{r}
par(mfrow=c(2,2))
plot(babies_lm1)
par(mfrow=c(1,1))
```

a.  Comment on the quality of the model given the four diagnostic plots and the linear regression summary table.
b.  Other variables of interest include length of pregnancy in days (gestation), mother's age in years (age), mother's height in inches (height), and mother's pregnancy weight in pounds (weight). Below are the sorted residual plots. Which variable(s) should be added to the model and why?

```{r}
babies$residuals <- babies_lm1$residuals
```

```{r}
babiesplot <- ggplot(babies, aes(y=residuals))
b1 <- babiesplot + geom_point(aes(x=gestation))
b2 <- babiesplot + geom_point(aes(x=age))
b3 <- babiesplot + geom_point(aes(x=height))
b4 <- babiesplot + geom_point(aes(x=weight))
multiplot(b1, b2, b3, b4, cols=2)
```

# North Carolina Baby weights


1. In 2004, the state of North Carolina released to the public a large data set containing information on births recorded in this state. This data set has been of interest to medical researchers who are studying the relationship between habits and practices of expectant mothers and the birth of their children. This is a random sample of 1,000 cases from this data set looking at the length of the pregnancy in weeks at birth (weeks) and if the baby was female or male.


```{r}
data(ncbirths)
ncbirths <- ncbirths[complete.cases(ncbirths),]
ncbirths_lm <- lm(weight ~ weeks + gender, data=ncbirths)
anova(ncbirths_lm)
```


```{r}
par(mfrow=c(2,2))
plot(ncbirths_lm)
par(mfrow=c(1,1))
```

a.  Comment on the quality of the model given the four diagnostic plots and the linear regression summary table.
b.  Other variables of interest include the number of hospital visits during pregnancy (visits), the amount of weight gained by the mother (gained), if the mother was a smoker or not (habit) and the mothers age in years (mage) . Below are the sorted residual plots. Which variable(s) should be added to the model and why?

```{r}
ncbirths$residuals <- ncbirths_lm$residuals
```

```{r}
ncbirthsplot <- ggplot(ncbirths, aes(y=residuals))
n1 <- ncbirthsplot + geom_point(aes(x=visits))
n2 <- ncbirthsplot + geom_point(aes(x=gained))
n3 <- ncbirthsplot + geom_point(aes(x=habit))
n4 <- ncbirthsplot + geom_point(aes(x=mage))
multiplot(n1, n2, n3, n4, cols=2)
```


# Simulation 