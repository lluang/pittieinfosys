---
title: "Visualization"
author: "IE 0015 Spring 2020"
date: "January 2020"
output:
  pdf_document: default
  beamer_presentation: 
    colortheme: whale
    theme: AnnArbor
    fig_height: 4
    fig_width: 6
  slidy_presentation: default
  html_document:
    fig_height: 4
    fig_width: 6
---


Midterm
=========

-  CoNVO
    -  These are the article discussions we have every week. (we talked through the RegionEx CoNVO statement when we introduced the case)
-  Data manipulation (verbs)
    -  Flow charts/Process maps
      -  SQL, R, plain English
    -  Aggregation
    -  We will not be grading syntax
-  Data analysis
  -  Sketch a visualization
  -  Interpret a data summary or data visualization

Where to find help on the internet
==================

- CoNVO - Everyone (consulting firms) has their own framework for expressing the problem
- Visualization
    -  We use ggplot (vs lattice)
- R in general  
    -  CrossValidated https://stats.stackexchange.com/questions/tagged/r
    -  We use the `tidyverse` family of packages

Summarizing data
=================


What is visualization for?
==========================

-  Analysis and exploration
-  Communicate and present information
-  Entertainment
-  Art


How do we represent data?
=========================

-  Use visual cues to show values.
-  Shapes, colors, scales, position.
-  Visualization is how we summarize raw data to communicate meaning.
-  What makes for a good visualization?


Visualization components
========================


![](figures/visualizationcomponents.jpg)


Visual cues
===========


![](figures/visualcues.jpg)

Ranking visual cues
===================

Some visual cues are more clear than others


![](figures/visualcuesranked.jpg)

Coordinate systems
==================

Coordinate systems dictate the dimensions of the visualization.


![](figures/coordinatesystems.jpg)

Scales
======

Scales dictate where in the dimensions the data maps to.


![](figures/visualscales.jpg)

Using visualization
===================

Data exploration questions to ask?
==================================

-  What data do you have?
-  What do you want to know about your data?
-  Which visualization methods should you use?
-  What do you see and does it make sense?

Choosing a visualization
=========================

-  What is the main point of the chart?
    - Comparison, relationship, distribution, composition
-  How many dimensions are we trying to communicate?
    - One, two, many
-  How do values change?
    - Over time, among items, static?
-  How much data is there?
    - Few data points, many data points?
    - Continuous, discrete?

Thinking about types of visualizations
====================================

![](figures/chart-suggestion-infographic.jpg)


Visualizing categorical data
============================


![](figures/visualizationcategorical.jpg)



Time
====

Time is continuous, but you can also divide it into categories.

![](figures/visualizationtime.jpg)


Time series
===========

How does your data change over time?


![](figures/visualizationtimeseries.jpg)

Visualizing spatial data
========================


![](figures/visualizationspatial.jpg)

Combining components
====================

By combining components, graphs are richer and can display many relationships at once.


![](figures/visualcombinations.jpg)


Multiple variables
==================

There is no hard limit to how many variables can be in one visualization


![](figures/visualizationmultiple.jpg)

Data distribution
=================

- Visualization can show how data is distributed in a population
- Box plots
- Histograms
- Density plots

Visualizing distributions
=========================

![](figures/visualizationdistributions.jpg)


Comparisons
===========

One thing that visualizations should do is show how things change.

![](figures/visualcomparisons.jpg)

Color scales
============

-  Sequential
-  Diverging
-  Qualitative

![](figures/visualizationcolorscales.jpg)


Highlighting
============

Emphasize a particular data point or series to place focus

![](figures/visualizationhighlighting.jpg)

Annotation
==========

Give context to data or explain boundary cases.


![](figures/visualannotations.jpg)

Making things pretty
====================

- Thinking about aesthetics helps tell the story.

![Wind contour map](figures/visualizationwind.jpg)

How to use visualizations
=======

-  Think in terms of telling a story.
-  What is the message?
-  What is the main point?
-  How to tell it?



## Visualizations in ggplot

-  Geometries and statistical summaries
-  Scales, Axis, and Legends
-  Colors


## Geometries and statistics

## Geom

- A *geom* is the geometrical object that a plot uses to represent data.
- We have been identifying the data to be represented in the main `ggplot()` function, but we could represent it in the `geom_()` function.
- We do this because we want to change the statistic represented or because we will plot many things in the same chart.

```{r}
library(ggplot2)
dsmall = diamonds[sample(nrow(diamonds),200),]
```

Diamond scatter plots
=========

These two are the same. I will usually name the dataset in the `ggplot()` function and the aesthetic mapping in the `geom_()` command

```{r}
ggplot(dsmall, aes(x=carat, y=price)) + geom_point()
```
***

```{r}
ggplot(dsmall) + geom_point(mapping = aes(x=carat, y=price))
```

Setting attributes
======================

-  One reason to use this version is that some aesthetics only make sense with certain *geom*, so keeping the aesthetics with the `geom_()` function makes sense.
-  The `geom_smooth()` function takes data and creates a single curve that draws the conditional mean (mean of `y` given `x` along with a shaded region that represents the confidence interval around the mean at the given `x`. 
-  In addition to `x` and `y`, you can specify the line type, `lintype`
  - solid
  - dashed
  - dotted
  - dash-dot
  - etc.
  
`geom_smooth()` with using linetype for adding a dimension
=================



```{r}
ggplot(dsmall) +
  geom_smooth(mapping = aes(x = carat, y = price))
```
```{r}
ggplot(dsmall) +
  geom_smooth(mapping = aes(x = carat, y = price, linetype = color, color=color))
```

Overlaying representations
=================

- You can then overlay multiple representations of the same data to provide more information.

```{r}
ggplot(dsmall) +
  geom_point(mapping = aes(x=carat, y=price)) +
  geom_smooth(mapping = aes(x = carat, y = price))
```

Using representations to show more facets
=================

- The aesthetics do not have to be the same for each layer of the plot.
- Use one to provide overall summaries, and use another to show how it varies

```{r}
ggplot(dsmall) +
  geom_point(mapping = aes(x=carat, y=price, color = color)) +
  geom_smooth(mapping = aes(x = carat, y = price))
```


Another example of multiple layers
=================

- Emphasize the individual points.
- Use summary data to show how the groups are distributed differently.

```{r}
ggplot(dsmall) +
  geom_point(mapping = aes(x=carat, y=price)) +
  geom_smooth(mapping = aes(x = carat, y = price, color = color, group = color, lintype=color))
```

Stat
==========

-  We can specify a chart type by the `geom` or by `stat`
-  Each `geom` has a default `stat`
-  Each `stat` has a default `geom`
-  But the default can be changed.

Bar chart
===========

- The default `stat` for `geom_bar()` is a count.
- The default `geom` for `stat_count()` is a `bar`

```{r}
ggplot(data=diamonds) +
  geom_bar(mapping=aes(x=cut))
```

```{r}
ggplot(data=diamonds) + 
  stat_count(mapping = aes(x=cut))
```

Changing the default `stat`
==================

-  Sometimes you want to change this.
-  Example, you want to use a bar chart, and you have been given summary data.
-  The `identity` stat is the actual value in the aesthetic being displayed.

```{r}
demo <- data.frame(a=c('bar1', 'bar2', 'bar3'),
                   b=c(20, 30, 40))
ggplot(data=demo) +
  geom_bar(mapping=aes(x=a, y=b), stat="identity")
```

You can also plot a summary
===================

-  Proportions can be generated by a count over the sum of all counts
-  The `..` operator can be used to refer to any *value* calculated by a `geom_` or `stat_` function.

```{r}
ggplot(data=diamonds) +
  geom_bar(mapping=aes(x=cut, y = (..count..)/sum(..count..)), stat="count") +
  ylab("Proportion") +
  ggtitle("Proportion of diamonds with a specific cut")
```

Many `stat_()` transforms have corresponding `geom_()` 
=====

- stat_bin(): geom_bar(), geom_freqpoly(), geom_histogram()
- stat_bin2d(): geom_bin2d()
- stat_bindot(): - geom_dotplot()
- stat_binhex(): geom_hex()
- stat_boxplot(): geom_boxplot()
- stat_contour(): geom_contour()
- stat_quantile(): geom_quantile()
- stat_smooth(): geom_smooth()
- stat_sum(): geom_count()

Some other important `stat` plots
==========

- `stat_count()`
- `stat_identity()`
- `stat_summary()`
- `stat_ellipse()`
- `stat_smooth()`
- `stat_ecdf()`
- `stat_qq()`
- `stat_function()`

`stat_identity()`
=====

- Uses the value of the variable in the aesthetic to plot.
- Contrast to `stat_count()` which counts number of occurrences (like bar charts)

```{r}
summary(demo)
ggplot(demo) + stat_identity(aes(x=a, y=b))
```

`stat_summary()`
===

- Plots a summary of the `y`-values for each unique `x`-value.
- Specify what functions should be mapped to the beginning and end of the line, and the center point.

```{r}
ggplot(diamonds) + 
  stat_summary(aes(cut, depth),
               fun.ymin=min,
               fun.ymax=max,
               fun.y=median
  )
```

stat_summary variations
============

-  `stat_summary_2d()`
-  `stat_summary_hex()`

-  Data is binned in `x` and `y`, then values of `z` are summarized using functions specified in the parameter.

`stat_ellipse()`
=====

- Draws an ellipse around the the bulk of the data.
- Useful for emphasizing the range of the data over two dimensions that is tighter than drawing a box.

```{r}
ggplot(dsmall, aes(log(carat), log(price))) +
  geom_point(aes(color=cut)) +
  stat_ellipse()
```

`stat_smooth()`
======
- Draws a mean and confidence interval of `y` at a given `x`.
- A range of methods are available.
- Compare to using `stat_ellipse()`

```{r}
ggplot(dsmall, aes(log(carat), log(price))) +
  geom_point(aes(color=cut)) +
  stat_smooth()
```

`stat_ecdf()`
=====

- Empirical Cumulative Distribution Function.
- Probability of a sample being less than a given number.

```{r}
ggplot(diamonds) + 
  stat_ecdf(aes(carat))
```

`stat_qq()`
=============

- Quantile-quantile plot
- In probability, used to compare data to a theoretical distribution.
- Very often used to determine if data is normally distributed or exponentially distributed.
  - Errors of statistical models should be normally distributed.

```{r}
lmdiamonds <- lm(price ~ carat, dsmall)
dflmdiamonds <- data.frame(residuals = lmdiamonds$residuals, prediction = lmdiamonds$fitted.values)
ggplot(dflmdiamonds) + stat_qq(aes(sample=residuals))
```


`stat_function`
===========

- Superimposes a function on top of the plot.

```{r}
df <- data.frame(
  x = rnorm(100)
)
base <- ggplot(df, aes(x)) + geom_density()
base + stat_function(fun = dnorm, colour = "red")
```


Scales, Axis, and Legends
===========

- Data does not speak by itself.
- You must explain the data.
- Scales, axis, legends, and titles tell the viewer how to interpret the plot.
- Always include them if you expect the plot to be seen by someone other than the one who made it.

Scales
=======

- Every aesthetic in a plot requires a scale.
- Some aesthetics have default scales.

```{r}
ggplot(dsmall, aes(log(carat) , log(price))) +
  geom_point() +
  scale_x_continuous() +
  scale_y_continuous()
```

Name of scale functions
================

- There are three parts of a scale function, separated by underscores (`_`).
  - `scale`
  - Name of aesthetic (e.g. `x`, `y`, `color`, `shape`)
  - Name of scale (e.g. `continuous`, `discrete`, `brewer`)
    - `brewer` indicates a color scale.
    
Scale commands
=====

```
scale_x_continuous(name, breaks, labels, limits, trans)
```

- name : x or y axis labels
- breaks : control the breaks in the guide (axis ticks, grid lines, …). Among the possible values, there are :
    - NULL : hide all breaks
    - waiver() : the default break computation
    - a character or numeric vector specifying the breaks to display
- labels : labels of axis tick marks. Allowed values are :
    - NULL for no labels
    - waiver() for the default labels
    - character vector to be used for break labels
- limits : a numeric vector specifying x or y axis limits (min, max)
trans for axis transformations. Possible values are “log2”, “log10”, “sqrt”, etc

Short cuts for axis
==============

- `scale_x_continuous()`: `xlab()`
- `scale_y_continuous()`: `ylab()`
- For both at the same time: `labs()`

Breaks and labels
=====================

-  Breaks and labels are the values that appear in the scale.
-  R and `ggplot` attempt to have sensible defaults that tradeoff between avoiding being to busy and not having enough information.
-  If you specify labels, you must specify breaks.

===

```{r}
ggplot(dsmall, aes(carat, price)) +
  geom_point() +
  scale_x_continuous(breaks= 1:3)
```

```{r}
ggplot(dsmall, aes(carat, price)) +
  geom_point() +
  scale_x_continuous(breaks= seq(0,3,.25))
```

Scale labeling options
=============

Some other common labeling options in the `scales` package include:

- `scales:dollar_format()`: use currency symbols.
- `scales:unit_format()`: Include units in legend.
- `scales:wrap_format()`: Uses multiple lines for long labels.

Legends
=======

- A *legend* is the part of the chart that defines the symbols used for various groups. (e.g. color, shape, line type)
- There can be multiple layers being defined.
- A legend also requires parameters such as location, number of columns, horizontal/vertical orientation, etc.

Specifying a legend
===========

- A legend is only defined for variables mapped by `aes()`.
```{r}
ggplot(dsmall) + geom_point(aes(carat, price, color=color), show.legend=TRUE)
```

You can map multiple layers to the same legend.
======
```{r}
ggplot(dsmall) + geom_point(aes(carat, price, color=cut, shape=cut), show.legend=TRUE)
```


Theme
=====

The theme controls the non-data components of the plot.

- Title
- Axis titles

Defined themes
=====

-  There are defined themes.
-  ` theme_grey()` Default (grey background with white grid)
-  `theme_bw()`
-  `theme_dark()`

You can change theme elements
=============

- http://docs.ggplot2.org/current/theme.html
- e.g. rotate the x-axis text.

```{r}
ggplot(data=diamonds) +
  geom_bar(mapping=aes(x=cut)) +
  theme(axis.text.x = element_text(angle=90))
```

Legend layout
====

- A legend can be either positioned `right`, `left`, `top`, `bottom`, or `none`

```{r}
ggplot(dsmall) + geom_point(aes(carat, price, color=cut, shape=cut), show.legend=TRUE) +
  theme(legend.position="right")
```

legend.position = "left"
===

```{r}
ggplot(dsmall) + geom_point(aes(carat, price, color=cut, shape=cut), show.legend=TRUE) +
  theme(legend.position="left")
```

legend.position = "top"
===

```{r}
ggplot(dsmall) + geom_point(aes(carat, price, color=cut, shape=cut), show.legend=TRUE) +
  theme(legend.position="top")
```

legend.position = "bottom"
===

```{r}
ggplot(dsmall) + geom_point(aes(carat, price, color=cut, shape=cut), show.legend=TRUE) +
  theme(legend.position="bottom")
```

legend.position = "none"
===

```{r}
ggplot(dsmall) + geom_point(aes(carat, price, color=cut, shape=cut), show.legend=TRUE) +
  theme(legend.position="none")
```

Limits
=====

- The ends of the scale are usually determined from the data.
- You may set this manually if there are a set of plots that need to be comparable to each other.
- Or you may want focus on an interesting section of the data.

====

```{r}
ggplot(dsmall) + geom_point(aes(carat, price, color=cut, shape=cut), show.legend=TRUE) +
  scale_x_continuous(limits= c(0.5, 1.5))
```

Setting limits
==========

- `xlim()` and `ylim()` are shortcuts for setting limits.
- Limits can be anything: numerical, discrete, categorical, dates.
  - `ggplot` will do the right thing in each of those settings.
  
Scale transformations
============

- You can transform the scale independently of the aesthetic.
- E.g. log, exponential, reciprocal, power/root

```{r}
ggplot(dsmall, aes(carat, price)) +
  geom_point() +
  scale_x_continuous(name = "log10(carat)", trans="log10") + 
  scale_y_continuous(name = "log10(price)", trans="log10")
```

Colors
======

- Colors are a very common scale.
- We need a way to pick colors that are visually distinct.
- We also have to be concerned with color blindness and printing/photocopy on black and white.

Specifying colors
===================

- You may be familiar with RGB (screen) or CMYK (print) color specifications.
- We use Hue, Chroma, Luminance, because the colors that are equidistant in value are (roughly) equidistant in perception. 
  - Hue: the value that "colour" for the color (e.g. red, green, blue)
  - Chroma: the purity of a color.
  - Luminance: the brightness of the color.
- Hue is *not* ordered. Chroma and Luminance are ordered.
- Some HCL combinations are named colors (i.e. like your crayon box)

Gradients
=======

- Color gradients can be:
  - Continuous
  - Discrete
  - Identity
  
Continuous color gradients
============

- `scale_color_gradient(), scale_fill_gradient()`: two color gradient, specify a `low` and a `high` color.  
  - Generally, use the same hue, change chroma and luminance.
  
```{r}
erupt <- ggplot(faithfuld, aes(waiting, eruptions, fill=density)) + 
  geom_raster() + 
  scale_x_continuous( expand=c(0,0)) +
  scale_y_continuous(expand=c(0,0)) + 
  theme(legend.position="none")
```

Color scales: black to white
====
```{r}
erupt + scale_fill_gradient(low="white", high="black")
```

Color scales: light to dark
====
```{r}
erupt + scale_fill_gradient(low="white", high="black")
```

Color Brewer
======

- *ColorBrewer* is a standard for specifying color schemes for use in charts.
- Go to http://colorbrewer2.org

scale_fill_distiller with ColorBrewer palettes
=====
- `scale_fill_distiller` uses the ColorBrewer palettes to fill.

```{r}
erupt + scale_fill_distiller(palette="Greys")
```

Normally, you use a single color
======

```{r}
erupt + scale_fill_distiller(palette="Greens")
```

There are some multi-color schemes that work
===
```{r}
erupt + scale_fill_distiller(palette="YlOrRd")
```

Discrete color palettes
===========

- We can use `scale_fill_hue` to set a range of hue.

```{r}
diamondcolor <- ggplot(dsmall, aes(color)) +
  geom_bar(aes(fill=color))
diamondcolor
```

Default is to change hue
================
- Problem, this will photocopy as uniform grey.
```{r}
diamondcolor +
  scale_fill_hue(c=40)
```

Color brewer
=============

- `scale_fill_brewer()`: uses ColorBrewer palettes.

```{r}
diamondcolor + scale_fill_brewer(palette="Greys")
```

Color brewer
=============

- `scale_fill_brewer()`: uses ColorBrewer palettes.


There are some predefined palettes
===
```{r}
diamondcolor + scale_fill_brewer(palette="Set1")
```

Color brewer
=============

- `scale_fill_brewer()`: uses ColorBrewer palettes.

Another predefined palette that may be better for fills (areas)
=====
```{r}
diamondcolor + scale_fill_brewer(palette="Set2")
```

And a standard set of grays
=============

- `scale_fill_grey()` takes a start and end as the fraction of black (vs white), with 0 being white and 1 being black.

```{r}
diamondcolor + scale_fill_grey(start = 0.2, end=0.9)
```

scale_color_identity
===============

- You can also pull a color from the data itself, if it is in the LUV color space (which is similar to HCL)

```{r}
ggplot(luv_colours, aes(u, v)) +
  geom_point(aes(color=col), size=3) +
  scale_color_identity() + 
  coord_equal()
```       


Theme (repeat for printing)
=====

The theme controls the non-data components of the plot.

- Title
- Axis titles

Defined themes
=====

-  There are defined themes.
-  ` theme_grey()` Default (grey background with white grid)
-  `theme_bw()`
-  `theme_dark()`

You can change theme elements
=============

- http://docs.ggplot2.org/current/theme.html
- e.g. rotate the x-axis text.

```{r}
ggplot(data=diamonds) +
  geom_bar(mapping=aes(x=cut)) +
  theme(axis.text.x = element_text(angle=90))
```
You can also plot a summary
===================

-  Proportions can be generated by a count over the sum of all counts
-  The `..` operator can be used to refer to any *value* calculated by a `geom_` or `stat_` function.

```{r}
ggplot(data=diamonds) +
  geom_bar(mapping=aes(x=cut, y = (..count..)/sum(..count..)), stat="count") +
  ylab("Proportion") +
  ggtitle("Proportion of diamonds with a specific cut")
```
